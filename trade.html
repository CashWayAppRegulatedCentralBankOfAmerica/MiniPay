<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1a1a2e" />
  <title>NovaFX Trading</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lightweight-charts@3.7.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body class="bg-[#1a1a2e] text-white font-sans antialiased">
  <div class="w-full px-2 max-w-3xl mx-auto mt-4 space-y-4">
    <div class="bg-gray-900 rounded-2xl p-4">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-bold">Trade Forex</h2>
        <a href="dashboard.html" class="text-sm text-blue-400 underline">Go to Dashboard</a>
      </div>
      <select id="pair-select" class="w-full p-2 rounded-lg bg-gray-700 text-white"></select>
      <div class="grid grid-cols-3 gap-2 mt-2">
        <input type="number" id="lot-size" placeholder="Lot Size (e.g. 0.01)" step="0.01" min="0.01" class="p-2 rounded-lg bg-gray-700 text-white" />
        <input type="number" id="stop-loss" placeholder="Stop Loss" class="p-2 rounded-lg bg-gray-700 text-white" />
        <input type="number" id="take-profit" placeholder="Take Profit" class="p-2 rounded-lg bg-gray-700 text-white" />
      </div>
      <div class="grid grid-cols-2 gap-2 mt-3">
        <button onclick="openTrade('buy')" class="bg-green-600 py-2 rounded-xl font-semibold">Buy</button>
        <button onclick="openTrade('sell')" class="bg-red-600 py-2 rounded-xl font-semibold">Sell</button>
      </div>
    </div>

    <div class="bg-blue-600 rounded-2xl p-4">
      <h3 class="text-lg font-semibold mb-2">Live Chart</h3>
      <div class="bg-blue-800 rounded-xl h-64" id="chart"></div>
    </div>
  </div>

  <script>
    const pairSelect = document.getElementById("pair-select");
    const pairs = [
      "EUR/USD", "GBP/USD", "USD/JPY", "USD/KES", "AUD/USD",
      "USD/CHF", "NZD/USD", "EUR/JPY", "GBP/JPY", "USD/CAD", "XAU/USD"
    ];

    function renderPairs() {
      pairSelect.innerHTML = pairs.map(p => `<option value="${p}">${p}</option>`).join("");
    }

    function fetchLivePrice(pair) {
      // Simulate TradingView fetch (replace with real API integration)
      const base = 1.0 + Math.random();
      const price = parseFloat((base + (Math.random() - 0.5) * 0.01).toFixed(5));
      return price;
    }

    function updateChart(pair) {
      const prices = Array.from({length: 30}, (_, i) => ({
        time: (Date.now() / 1000 | 0) - i * 60,
        value: fetchLivePrice(pair)
      })).reverse();
      chartSeries.setData(prices);
    }

    function openTrade(type) {
      const pair = pairSelect.value;
      const lot = parseFloat(document.getElementById("lot-size").value);
      const sl = parseFloat(document.getElementById("stop-loss").value);
      const tp = parseFloat(document.getElementById("take-profit").value);
      const price = fetchLivePrice(pair);

      if (!lot || lot < 0.01) return alert("Lot size too small");
      if (isNaN(sl) || isNaN(tp)) return alert("SL and TP required");
      if ((type === 'buy' && (sl >= price || tp <= price)) || (type === 'sell' && (sl <= price || tp >= price))) {
        return alert("Invalid SL or TP");
      }

      const acc = JSON.parse(localStorage.getItem("account")) || {
        balance: 1000, equity: 1000, usedMargin: 0, pnl: 0, trades: [], history: []
      };

      if (acc.freeMargin !== undefined && acc.freeMargin < lot * 100) {
        alert("Insufficient margin.");
        return;
      }

      acc.usedMargin += lot * 100;
      acc.trades.push({pair, lot, type, openPrice: price, sl, tp});
      localStorage.setItem("account", JSON.stringify(acc));
      alert("Trade opened successfully!");
    }

    renderPairs();
    pairSelect.addEventListener('change', () => updateChart(pairSelect.value));

    // Lightweight Chart Init
    const chart = LightweightCharts.createChart(document.getElementById("chart"), {
      layout: { background: { color: '#1e3a8a' }, textColor: 'white' }
    });
    const chartSeries = chart.addLineSeries();
    updateChart(pairSelect.value);
    setInterval(() => updateChart(pairSelect.value), 2000);
  </script>
</body>
</html>
