<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NovaFX Trading</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#1a1a2e] text-white p-4 font-sans">
  <div class="max-w-xl mx-auto space-y-6">
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-bold">Trade Market</h1>
      <a href="dashboard.html" class="text-sm text-blue-400 underline">Dashboard</a>
    </div>

    <div>
      <label for="pair" class="block mb-1">Select Pair</label>
      <select id="pair" class="w-full p-2 rounded bg-gray-800">
        <option value="EUR/USD">EUR/USD</option>
        <option value="GBP/USD">GBP/USD</option>
        <option value="USD/JPY">USD/JPY</option>
        <option value="USD/KES">USD/KES</option>
        <option value="AUD/USD">AUD/USD</option>
        <option value="USD/CHF">USD/CHF</option>
        <option value="NZD/USD">NZD/USD</option>
        <option value="EUR/JPY">EUR/JPY</option>
        <option value="GBP/JPY">GBP/JPY</option>
        <option value="USD/CAD">USD/CAD</option>
        <option value="XAU/USD">XAU/USD (Gold)</option>
      </select>
    </div>

    <div id="chart" class="w-full h-64"></div>

    <form id="trade-form" class="space-y-4">
      <div>
        <input type="number" step="0.01" id="lot" placeholder="Lot Size (min 0.01)" class="w-full p-2 bg-gray-800 rounded">
      </div>
      <div>
        <input type="number" id="sl" placeholder="Stop Loss" class="w-full p-2 bg-gray-800 rounded">
      </div>
      <div>
        <input type="number" id="tp" placeholder="Take Profit" class="w-full p-2 bg-gray-800 rounded">
      </div>
      <div class="grid grid-cols-2 gap-2">
        <button type="button" onclick="executeTrade('buy')" class="bg-green-600 py-2 rounded">Buy</button>
        <button type="button" onclick="executeTrade('sell')" class="bg-red-600 py-2 rounded">Sell</button>
      </div>
    </form>

    <a href="history.html" class="block text-center mt-4 text-blue-300 underline">View Trade History</a>
  </div>

  <script>
   const pairs = [
  "EUR/USD", "GBP/USD", "USD/JPY", "USD/KES", "AUD/USD",
  "USD/CHF", "NZD/USD", "EUR/JPY", "GBP/JPY", "USD/CAD", "XAU/USD"
];
let selectedPair = pairs[0];
let market = {};

const pairSelect = document.getElementById("pair-select");
const marketPrices = document.getElementById("market-prices");
const lotInput = document.getElementById("lot-size");
const slInput = document.getElementById("stop-loss");
const tpInput = document.getElementById("take-profit");

function renderPairs() {
  pairSelect.innerHTML = pairs.map(p => `<option value="${p}">${p}</option>`).join("");
}

function fetchMarketPrices() {
  pairs.forEach(pair => {
    const symbol = pair.replace("/", "");
    fetch(`https://api.twelvedata.com/price?symbol=${symbol}&apikey=fa443b33e32c49e1b03c0be6d9699b1c`)
      .then(res => res.json())
      .then(data => {
        market[pair] = parseFloat(data.price);
        if (pair === selectedPair) {
          updateAutoFill();
        }
        renderMarket();
      });
  });
}

function renderMarket() {
  marketPrices.innerHTML = pairs.map(pair => {
    const price = market[pair] ? market[pair].toFixed(5) : '...';
    // Indent and highlight selected pair's price on the left side
    if (pair === selectedPair) {
      return `<div class='flex justify-between font-bold'>
                <span class="ml-4">${price}</span>
                <span>${pair}</span>
              </div>`;
    } else {
      return `<div class='flex justify-between'>
                <span class="ml-0">${price}</span>
                <span>${pair}</span>
              </div>`;
    }
  }).join("");
}

function updateAutoFill() {
  const price = market[selectedPair];
  if (!price) return;

  // Use lot size for buffer calculation (example: buffer scales with lot size)
  const lot = parseFloat(lotInput.value) || 1;
  // Define buffer in pips; e.g., for most pairs 1 pip = 0.0001, for JPY pairs 0.01, for XAU larger
  const pipValue = getPipValue(selectedPair);
  const bufferPips = 10 * lot; // 10 pips times lot size, can be adjusted

  const buffer = bufferPips * pipValue;

  // For buy trades: SL below price, TP above price
  slInput.value = (price - buffer).toFixed(5);
  tpInput.value = (price + buffer).toFixed(5);
}

function getPipValue(pair) {
  // Returns pip size for pair, adjust as needed
  if (pair.includes("JPY")) return 0.01;
  if (pair === "XAU/USD") return 0.1; // gold pip size bigger
  return 0.0001;
}

// Update SL and TP when lot size changes
lotInput.addEventListener("input", () => {
  updateAutoFill();
});

// Update on pair change
pairSelect.addEventListener("change", (e) => {
  selectedPair = e.target.value;
  updateAutoFill();
  renderChart(selectedPair);
});

function renderChart(pair) {
  const symbol = pair.replace("/", "");
  document.getElementById("tv-chart").innerHTML = "";
  new TradingView.widget({
    autosize: true,
    symbol: `OANDA:${symbol}`,
    interval: "1",
    timezone: "Etc/UTC",
    theme: "dark",
    style: "1",
    locale: "en",
    container_id: "tv-chart"
  });
}

function submitTrade(type) {
  const lot = parseFloat(lotInput.value);
  const sl = parseFloat(slInput.value);
  const tp = parseFloat(tpInput.value);
  const price = market[selectedPair];
  if (!lot || lot < 0.01) return alert("Invalid lot size");
  if (type === 'buy' && (sl >= price || tp <= price)) return alert("Invalid SL/TP for Buy");
  if (type === 'sell' && (sl <= price || tp >= price)) return alert("Invalid SL/TP for Sell");
  const trades = JSON.parse(localStorage.getItem("trades") || "[]");
  trades.push({ pair: selectedPair, lot, type, price, sl, tp, opened: Date.now() });
  localStorage.setItem("trades", JSON.stringify(trades));
  alert(`${type.toUpperCase()} order for ${selectedPair} placed.`);
}

renderPairs();
renderChart(selectedPair);
fetchMarketPrices();
setInterval(fetchMarketPrices, 3000);

  </script>
</body>
</html>
